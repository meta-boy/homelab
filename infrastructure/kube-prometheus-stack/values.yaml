kube-prometheus-stack:
  # Grafana Configuration
  grafana:
    enabled: true

    # Admin credentials - managed via Infisical ExternalSecret
    admin:
      existingSecret: grafana-admin-credentials
      userKey: admin-user
      passwordKey: admin-password

    # Ingress configuration matching ArgoCD pattern
    ingress:
      enabled: true
      ingressClassName: nginx
      annotations:
        nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
      hosts:
        - grafana.is-up-in.space
      path: /
      pathType: Prefix

    # Persistence for dashboards and data
    persistence:
      enabled: true
      storageClassName: local-path
      size: 2Gi

    # Data sources - auto-configured to use Prometheus
    datasources:
      datasources.yaml:
        apiVersion: 1
        datasources:
          - name: Prometheus
            type: prometheus
            url: http://kube-prometheus-stack-prometheus:9090
            access: proxy
            isDefault: true

    # Resources
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Enable default dashboards
    defaultDashboardsEnabled: true
    defaultDashboardsTimezone: UTC

    # Grafana Sidecar - auto-import dashboards from ConfigMaps
    sidecar:
      dashboards:
        enabled: true
        searchNamespace: ALL
      datasources:
        enabled: true
        searchNamespace: ALL

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 472
      fsGroup: 472
      seccompProfile:
        type: RuntimeDefault

    containerSecurityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: false

  # Prometheus Configuration
  prometheus:
    enabled: true

    prometheusSpec:
      # Retention settings (reduced for limited resources)
      retention: 7d
      retentionSize: "4GB"

      # Storage configuration
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 5Gi

      # Resources (slightly reduced for limited resources)
      resources:
        requests:
          cpu: 200m
          memory: 512Mi
        limits:
          cpu: 1000m
          memory: 1536Mi

      # ServiceMonitor selector - discover all ServiceMonitors
      serviceMonitorSelector: {}
      serviceMonitorNamespaceSelector: {}

      # PodMonitor selector
      podMonitorSelector: {}
      podMonitorNamespaceSelector: {}

      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
        seccompProfile:
          type: RuntimeDefault

  # Alertmanager Configuration
  alertmanager:
    enabled: true

    alertmanagerSpec:
      # Storage for alert state (reduced for limited resources)
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-path
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 1Gi

      # Resources
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 128Mi

      # Security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 2000
        seccompProfile:
          type: RuntimeDefault

  # Prometheus Operator Configuration
  prometheusOperator:
    enabled: true

    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 65534
      seccompProfile:
        type: RuntimeDefault

  # Pushgateway Configuration
  prometheus-pushgateway:
    enabled: true

    serviceMonitor:
      enabled: true

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 100m
        memory: 128Mi

  # Node Exporter - collect node-level metrics
  prometheus-node-exporter:
    enabled: true

    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

  # Kube State Metrics - collect Kubernetes object metrics
  kube-state-metrics:
    enabled: true

    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

  # Default rules and alerts
  defaultRules:
    create: true
    rules:
      alertmanager: true
      etcd: false
      configReloaders: true
      general: true
      k8s: true
      kubeApiserver: true
      kubeApiserverAvailability: true
      kubeApiserverSlos: true
      kubelet: true
      kubeProxy: true
      kubePrometheusGeneral: true
      kubePrometheusNodeRecording: true
      kubernetesApps: true
      kubernetesResources: true
      kubernetesStorage: true
      kubernetesSystem: true
      kubeScheduler: true
      kubeStateMetrics: true
      network: true
      node: true
      nodeExporterAlerting: true
      nodeExporterRecording: true
      prometheus: true
      prometheusOperator: true
